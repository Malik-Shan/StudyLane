---
export const prerender = false;
import {getEntry} from 'astro:content';
import Blog from '../../../layouts/Blog.astro';
import {app} from '../../../firebase/server';
import {getAuth} from 'firebase-admin/auth';

const {subject, infoid} = Astro.params;
const infoEntry = await getEntry('subjects',`${subject}/${infoid}`);

const auth = getAuth(app);

if(infoEntry === undefined || infoEntry === null){
	return Astro.redirect('/404');
}
if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
const {Content} = await infoEntry.render();
---
<Blog title={infoEntry.data.title} imgSrc={infoEntry.data.bannerImg}>
	<Content/>
</Blog>
