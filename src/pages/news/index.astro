---
export const prerender = false;
import {getCollection} from 'astro:content';

import DefaultLayout from '../../layouts/DefaultLayout.astro';
import NewsBlog from '../../components/NewsBlog.astro';
import {app} from '../../firebase/server';
import {getAuth} from 'firebase-admin/auth';
import {formatAllPosts} from '../../js/util';

const auth = getAuth(app);

if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
const news = await getCollection('news');
const formatedNews = await formatAllPosts(news,{
	filterOutDraft : true,
	sortByDate : true,
	limit : undefined,
})
---
<DefaultLayout title='News'>
	<section class='newsSection container p-2 section-nav-pb pt-8 mx-auto'>
		<div class='newsCollection grid grid-cols-2 max-lg:grid-cols-1 gap-2'>
			{
			formatedNews.map((n) => (
				<NewsBlog title={n.data.title} link={`/news/${n.slug}`} date={n.data.published} category={n.data.category} position={n.data.postedBy}/>
			))
			}
		</div>
	</section>
</DefaultLayout>
