---
export const prerender = false;
import DefaultLayout from '../../../layouts/DefaultLayout.astro';
import {app} from '../../../firebase/server';
import {getAuth} from 'firebase-admin/auth';
import NewFeePaymentEntry from '../../../components/NewFeePaymentEntry.astro';
import NewEntryForm from '../../../components/NewEntryForm.astro';

const auth = getAuth(app)
const {id} = Astro.params;
const appscript = import.meta.env.APPSCRIPT_URL;

// Aut info here
if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
if(!decodedCookie.admin){
	return Astro.redirect('/404')
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
const res = await fetch(`${appscript}?type=getentry&id=${id}`);
const {result} = await res.json();
const entry = result[0];
---
<DefaultLayout title={`ID-#${entry.id}`}>
	<section class='entrySection section-nav-pb container mx-auto pt-4 px-3'>
		<form
			id={`entry-${id}`}
			hx-post='/api/database/spreadsheet/update'
			hx-headers={`{"rowIndex": "${entry.rowIndex}"}`}
			hx-swap='none'
			hx-swap-oob='true'
			hx-indicator='#submitIndicator'
			class="p-4 md:p-5">
			<NewEntryForm type='update' id={entry.id} name={entry.name} course={entry.course}f_inst={entry.first_inst} f_due={entry.first_due} s_inst={entry.sec_inst} s_due={entry.sec_due} t_inst={entry.third_inst} t_due={entry.third_due} fth_inst={entry.fourth_inst} fth_due={entry.fourth_due} totalfee={entry.total_fee} rowIndex={id}/>
		</form>
	</section>
</DefaultLayout>
