---
export const prerender = false;
import DefaultLayout from '../../layouts/DefaultLayout.astro';
import {app} from '../../firebase/server';
import {getAuth} from 'firebase-admin/auth';
import StudentPaymentCard from '../../components/StudentPaymentCard.astro';

const auth = getAuth(app)

if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
if(!decodedCookie.admin){
	return Astro.redirect('/404')
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
const res = await fetch('https://script.google.com/macros/s/AKfycbwz_x772Go6X0VZoIn5kvSSQxPHEPlDukLWkMZ9BC40xud7-wQgQIOYnIjJ2e7R9BBT4A/exec')
const {data} = await res.json()
---
<DefaultLayout title='Fees Payment'>
	<section class='student-fees-section section-nav-pb container mx-auto pt-4 px-3'>
		<div class='student-cards grid grid-cols-4 gap-2 max-xl:grid-cols-3 max-lg:grid-cols-2 max-sm:grid-cols-1'>
			{
			data.map((d) => (
				<StudentPaymentCard id={d.id} name={d.name} course={d.course} f_inst={d.first_inst} s_inst={d.sec_inst} t_inst={d.third_inst} fth_inst={d.fourth_inst} total_fee={d.total_fee} />
			))
			}
		</div>
	</section>
</DefaultLayout>
