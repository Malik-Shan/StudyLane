---
export const prerender = false;
import {db,Data} from 'astro:db';
import DefaultLayout from '../../layouts/DefaultLayout.astro';
import {app} from '../../firebase/server';
import {getAuth} from 'firebase-admin/auth';

const auth = getAuth(app);

if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
if (Astro.request.method === 'POST') {
  // parse form data
  const formData = await Astro.request.formData();
  const a = formData.get('assignment');
  const s = formData.get('subject');
  if (typeof a === 'string' && typeof s === 'string') {
    // insert form data into the Comment table
    await db.insert(Data).values({ a, s });
  }
}
const data = await db.select().from(Data);
---
<DefaultLayout title='Test Area'>

  <h2>Hello</h2>
  <form method='POST' class='mb-4 bg-secondary'>
    <label>
      Subject 
      <input class='border' type='text' id='subject' name='subject' />
    </label>
    <label>
      Assignment 
      <input class='border' type='text' id='assignment' name='assignment' />
    </label>
    <button class='bg-primary p-2 rounded-md text-white' type='submit'>Submit</button>
  </form>
  {data.map(d => <div class='bg-slate-200 mb-2'><h2><b>Assignment :</b>{d.a}</h2><h2><b>Subject :</b>{d.s}</h2></div>)}

</DefaultLayout>
