---
export const prerender = false;
import DefaultLayout from '../../../layouts/DefaultLayout.astro';
import {ImgToBit} from "../../../js/util";
import {app} from '../../../firebase/server';
import {getAuth} from 'firebase-admin/auth';
import {db,Subjects} from 'astro:db';

const auth = getAuth(app)

if(!Astro.cookies.has('session')){
	return Astro.redirect('/login');
}
const sessionCookie = Astro.cookies.get('session').value;
let decodedCookie;
try {
	decodedCookie = await auth.verifySessionCookie(sessionCookie);
}catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
if(!decodedCookie.roles.includes("admin")){
	return Astro.redirect('/404')
}
let user; 
try {
	user = await auth.getUser(decodedCookie.uid);
} catch(err){
	Astro.cookies.set('session','', {expires : new Date(0)});
	return Astro.redirect('/login');
}
---
<DefaultLayout title='Add User'>
	<section class='adduserSection section-nav-pb container mx-auto px-3'>
		<form  id="subjects_form"
			hx-trigger="submit"
			hx-post="/partials/admin/subjects"
			hx-swap="innerHTML"
			hx-target="#sub_res"
			enctype="multipart/form-data"
			class='newUser flex flex-row gap-2 justify-center mt-4 max-lg:flex-col'>
			<input type='text' name='id' placeholder='ID' />
			<input type="text" name='name' placeholder='Name'/>
			<input type="text" name='sname' placeholder='Name'/>
			<input type='file' id='subImg' name='subjectImg' />
			<input type='file' name='outline' multiple />
			<button class='primaryBtn p-1 rounded-md border-2' type='submit'>Add</button>
		</form>
		<div id='sub_res'></div>
	</section>
	<script>
		document.body.addEventListener('htmx:configRequest', (evt) => {
			if(evt.detail.headers['HX-Trigger'] === 'subjects_form'){

				const i = document.querySelector("#subImg").files[0];
				evt.detail.parameters["subImgData"] = 'Img data here';
				const url = ImgToBase(i);
				console.log(url)
			};
		});
		function ImgToBase(file){
			const reader = new FileReader();
			reader.readAsDataURL(file);
			let url;
			reader.onload = function(e){
				return url = e.target.result;
			}
			return url;
		}
	</script>
</DefaultLayout>
<style>
#subjects_form input{
	@apply border border-slate-200 p-2 rounded-md;
}
</style>
